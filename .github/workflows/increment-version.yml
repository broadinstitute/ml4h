name: Increment version

on:
  workflow_dispatch:
    # Allows manually triggering workflow in GitHub UI on selected branch.

  release:
    types: [published]


jobs:
  update_version:
    if: ${{ github.event.release.tag_name != '' }}
    name: Update version
    runs-on: ubuntu-latest
    steps:
      - name: Check out source code
        uses: actions/checkout@v3

      - name: Testing--dump env
        run: env | sort
      - name: Testing--dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"

      - name: Replace string in file
        run: |
          echo hello
          grep "version" setup.py
          sed  -i "s/version='[0-9.]*',/version='${{ github.event.release.tag_name }}',/g" setup.py

      - name: Check for swap
        run: cat setup.py

      - uses: actions/checkout@v4
      - run: |
          # Note: the following account information will not work on GHES
          git config user.name "github-actions[bot]"
          git config user.email {user.id}+{user.login}@users.noreply.github.com
          git add setup.py
          git commit -m "Version bump to ${{ github.event.release.tag_name }}'"
          git push


